{"version":3,"file":"focus-trap.js","sourceRoot":"","sources":["../../../../src/internal/utils/focus-trap.ts"],"names":[],"mappings":"AAAA;;;;GAIG;AAEH,OAAO,EAAE,UAAU,EAAE,MAAM,aAAa,CAAC;AACzC,OAAO,EAAE,sBAAsB,EAAE,gBAAgB,EAAE,MAAM,2CAA2C,CAAC;AACrG,OAAO,EAAE,aAAa,EAAE,WAAW,EAAE,MAAM,UAAU,CAAC;AACtD,OAAO,EAAE,QAAQ,EAAE,MAAM,eAAe,CAAC;AAQzC,MAAM,UAAU,gCAAgC,CAC9C,cAA2B,EAC3B,gBAAkC,EAClC,gBAA8B;IAE9B,MAAM,kBAAkB,GAAG,gBAAgB,CAAC,UAAU,EAAE,KAAK,gBAAgB,CAAC;IAC9E,MAAM,gCAAgC,GAAG,gCAAgC,CAAC,cAAc,EAAE,gBAAgB,CAAC,CAAC;IAE5G,IAAI,kBAAkB,IAAI,gCAAgC,EAAE;QAC1D,gBAAgB,GAAG,gBAAgB,IAAI,gBAAgB,CAAC;QACxD,gBAAgB,CAAC,KAAK,EAAE,CAAC;KAC1B;SAAM;QACL,cAAc,CAAC,KAAK,EAAE,CAAC;KACxB;AACH,CAAC;AAED,MAAM,UAAU,gCAAgC,CAC9C,cAA2B,EAC3B,gBAAkC;IAElC,IACE,cAAc,KAAK,gBAAgB,CAAC,iBAAiB;QACrD,cAAc,KAAK,gBAAgB,CAAC,oBAAoB,EACxD;QACA,OAAO,IAAI,CAAC;KACb;IAED,MAAM,4BAA4B,GAAG,gBAAgB,CAAC,QAAQ,CAAC,cAAc,CAAC,CAAC;IAE/E,IAAI,4BAA4B,EAAE;QAChC,OAAO,KAAK,CAAC;KACd;IAED,IAAI,gBAAgB,CAAC,UAAU,KAAK,IAAI,IAAI,gBAAgB,CAAC,UAAU,CAAC,QAAQ,CAAC,cAAc,CAAC,EAAE;QAChG,OAAO,KAAK,CAAC;KACd;IAED,OAAO,IAAI,CAAC;AACd,CAAC;AAED,MAAM,UAAU,6BAA6B;IAC3C,MAAM,aAAa,GAAG,QAAQ,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC;IACrD,aAAa,CAAC,YAAY,CAAC,UAAU,EAAE,GAAG,CAAC,CAAC;IAC5C,aAAa,CAAC,SAAS,CAAC,GAAG,CAAC,2BAA2B,CAAC,CAAC;IACzD,OAAO,aAAa,CAAC;AACvB,CAAC;AAED,MAAM,UAAU,oCAAoC,CAAC,gBAAkC;IACrF,IAAI,gBAAgB,IAAI,CAAC,gBAAgB,CAAC,iBAAiB,IAAI,CAAC,gBAAgB,CAAC,oBAAoB,EAAE;QACrG,gBAAgB,CAAC,iBAAiB,GAAG,6BAA6B,EAAE,CAAC;QACrE,gBAAgB,CAAC,oBAAoB,GAAG,6BAA6B,EAAE,CAAC;QAExE,MAAM,MAAM,GAAG,gBAAgB,CAAC,aAAa,CAAC;QAC9C,MAAM,OAAO,GAAG,gBAAgB,CAAC,WAAW,CAAC;QAE7C,IAAI,MAAM,EAAE;YACV,MAAM,CAAC,YAAY,CAAC,gBAAgB,CAAC,iBAAiB,EAAE,gBAAgB,CAAC,CAAC;YAC1E,IAAI,OAAO,EAAE;gBACX,MAAM,CAAC,YAAY,CAAC,gBAAgB,CAAC,oBAAoB,EAAE,OAAO,CAAC,CAAC;aACrE;iBAAM;gBACL,MAAM,CAAC,WAAW,CAAC,gBAAgB,CAAC,oBAAoB,CAAC,CAAC;aAC3D;SACF;KACF;AACH,CAAC;AAED,MAAM,UAAU,yCAAyC,CAAC,gBAAkC;IAC1F,IAAI,gBAAgB,EAAE;QACpB,MAAM,MAAM,GAAG,gBAAgB,CAAC,aAAa,CAAC;QAE9C,IAAI,MAAM,EAAE;YACV,MAAM,UAAU,GAAG,gBAAgB,CAAC,iBAAiB,CAAC;YACtD,MAAM,aAAa,GAAG,gBAAgB,CAAC,oBAAoB,CAAC;YAC5D,IAAI,UAAU,EAAE;gBACd,MAAM,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC;aAChC;YACD,IAAI,aAAa,EAAE;gBACjB,MAAM,CAAC,WAAW,CAAC,aAAa,CAAC,CAAC;aACnC;SACF;QACD,kGAAkG;QAClG,OAAO,gBAAgB,CAAC,iBAAiB,CAAC;QAC1C,OAAO,gBAAgB,CAAC,oBAAoB,CAAC;KAC9C;AACH,CAAC;AAED,oFAAoF;AACpF,4CAA4C;AAC5C,+EAA+E;AAC/E,mBAAmB;AACnB,MAAM,UAAU,iCAAiC,CAAC,EAAe;IAC/D,OAAO,EAAsB,CAAC;AAChC,CAAC;AAED,MAAM,OAAO,SAAS;IASpB,YAAY,WAA6B;QAFzC,WAAM,GAAG,KAAK,CAAC;QAGb,WAAW,GAAG,iCAAiC,CAAC,WAAW,CAAC,CAAC;QAE7D,IAAI,CAAC,WAAW,CAAC,WAAW,EAAE;YAC5B,WAAW,CAAC,WAAW,GAAG,QAAQ,EAAE,CAAC;SACtC;QAED,eAAe;QACf,yCAAyC;QACzC,0EAA0E;QAC1E,iEAAiE;QACjE,kEAAkE;QAClE,IAAI,CAAC,CAAC,WAAW,YAAY,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,sBAAsB,CAAC,EAAE;YAC7F,WAAW,CAAC,YAAY,CAAC,sBAAsB,EAAE,WAAW,CAAC,WAAW,CAAC,CAAC;SAC3E;QAED,IAAI,CAAC,gBAAgB,GAAG,WAAW,CAAC;IACtC,CAAC;IAED,eAAe;QACb,MAAM,GAAG,GAAG,IAAI,CAAC,gBAAgB,CAAC;QAClC,MAAM,iBAAiB,GAAG,GAAG,CAAC,aAAa,CAAC,mBAAmB,CAAC,CAAC;QACjE,MAAM,cAAc,GAAG,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC,GAAG,CAAC,UAAU,CAAC,aAAa,CAAC,yBAAyB,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC;QACvG,MAAM,QAAQ,GAAG,QAAQ,CAAC,aAAa,CAAC;QAExC,IAAI,gBAAgB,CAAC,UAAU,EAAE,KAAK,GAAG,EAAE;YACzC,MAAM,IAAI,KAAK,CAAC,kDAAkD,CAAC,CAAC;SACrE;QAED,IAAI,CAAC,iBAAiB;YACnB,iBAAiC,IAAK,cAA8B,IAAI,IAAI,CAAC,gBAAgB,CAAC;QAEjG,oCAAoC,CAAC,GAAG,CAAC,CAAC;QAE1C,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,EAAE;YACrB,GAAG,CAAC,YAAY,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;SACpC;QAED,IAAI,QAAQ,IAAI,aAAa,CAAC,QAAQ,CAAC,EAAE;YACvC,IAAI,CAAC,aAAa,GAAG,QAAuB,CAAC;SAC9C;QAED,gBAAgB,CAAC,UAAU,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;QAE7C,uEAAuE;QACvE,kCAAkC;QAClC,MAAM,UAAU,GAAG,UAAU,CAAC,GAAG,EAAE;YACjC,IAAI,CAAC,iBAAiB,CAAC,KAAK,EAAE,CAAC;YAC/B,YAAY,CAAC,UAAU,CAAC,CAAC;QAC3B,CAAC,EAAE,EAAE,CAAC,CAAC;QAEP,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAChD,QAAQ,CAAC,gBAAgB,CAAC,SAAS,EAAE,IAAI,CAAC,cAAc,CAAC,CAAC;QAC1D,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;IACrB,CAAC;IAED,eAAe;QACb,QAAQ,CAAC,mBAAmB,CAAC,SAAS,EAAE,IAAI,CAAC,cAAc,CAAC,CAAC;QAC7D,yCAAyC,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;QACjE,gBAAgB,CAAC,uBAAuB,EAAE,CAAC;QAC3C,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;QACpB,IAAI,IAAI,CAAC,aAAa,EAAE;YACtB,IAAI,CAAC,aAAa,CAAC,KAAK,EAAE,CAAC;SAC5B;IACH,CAAC;IAEO,SAAS,CAAC,KAAiB;QACjC,gCAAgC,CAC9B,KAAK,CAAC,YAAY,EAAE,CAAC,CAAC,CAAgB,EACtC,IAAI,CAAC,gBAAgB,EACrB,IAAI,CAAC,iBAAiB,CACvB,CAAC;IACJ,CAAC;CACF","sourcesContent":["/*\n * Copyright (c) 2016-2020 VMware, Inc. All Rights Reserved.\n * This software is released under MIT license.\n * The full license information can be found in LICENSE in the root directory of this project.\n */\n\nimport { LitElement } from 'lit-element';\nimport { CDS_FOCUS_TRAP_ID_ATTR, FocusTrapTracker } from '../services/focus-trap-tracker.service.js';\nimport { isHTMLElement, isFocusable } from './dom.js';\nimport { createId } from './identity.js';\n\nexport interface FocusTrapElement extends HTMLElement {\n  topReboundElement: HTMLElement | undefined;\n  bottomReboundElement: HTMLElement | undefined;\n  focusTrapId: string;\n}\n\nexport function refocusIfOutsideFocusTrapElement(\n  focusedElement: HTMLElement,\n  focusTrapElement: FocusTrapElement,\n  elementToRefocus?: HTMLElement\n) {\n  const focusTrapIsCurrent = FocusTrapTracker.getCurrent() === focusTrapElement;\n  const elementToFocusIsOutsideFocusTrap = elementIsOutsideFocusTrapElement(focusedElement, focusTrapElement);\n\n  if (focusTrapIsCurrent && elementToFocusIsOutsideFocusTrap) {\n    elementToRefocus = elementToRefocus || focusTrapElement;\n    elementToRefocus.focus();\n  } else {\n    focusedElement.focus();\n  }\n}\n\nexport function elementIsOutsideFocusTrapElement(\n  focusedElement: HTMLElement,\n  focusTrapElement: FocusTrapElement\n): boolean {\n  if (\n    focusedElement === focusTrapElement.topReboundElement ||\n    focusedElement === focusTrapElement.bottomReboundElement\n  ) {\n    return true;\n  }\n\n  const elementIsInFocusTrapLightDom = focusTrapElement.contains(focusedElement);\n\n  if (elementIsInFocusTrapLightDom) {\n    return false;\n  }\n\n  if (focusTrapElement.shadowRoot !== null && focusTrapElement.shadowRoot.contains(focusedElement)) {\n    return false;\n  }\n\n  return true;\n}\n\nexport function createFocusTrapReboundElement() {\n  const offScreenSpan = document.createElement('span');\n  offScreenSpan.setAttribute('tabindex', '0');\n  offScreenSpan.classList.add('offscreen-focus-rebounder');\n  return offScreenSpan;\n}\n\nexport function addReboundElementsToFocusTrapElement(focusTrapElement: FocusTrapElement) {\n  if (focusTrapElement && !focusTrapElement.topReboundElement && !focusTrapElement.bottomReboundElement) {\n    focusTrapElement.topReboundElement = createFocusTrapReboundElement();\n    focusTrapElement.bottomReboundElement = createFocusTrapReboundElement();\n\n    const parent = focusTrapElement.parentElement;\n    const sibling = focusTrapElement.nextSibling;\n\n    if (parent) {\n      parent.insertBefore(focusTrapElement.topReboundElement, focusTrapElement);\n      if (sibling) {\n        parent.insertBefore(focusTrapElement.bottomReboundElement, sibling);\n      } else {\n        parent.appendChild(focusTrapElement.bottomReboundElement);\n      }\n    }\n  }\n}\n\nexport function removeReboundElementsFromFocusTrapElement(focusTrapElement: FocusTrapElement) {\n  if (focusTrapElement) {\n    const parent = focusTrapElement.parentElement;\n\n    if (parent) {\n      const topRebound = focusTrapElement.topReboundElement;\n      const bottomRebound = focusTrapElement.bottomReboundElement;\n      if (topRebound) {\n        parent.removeChild(topRebound);\n      }\n      if (bottomRebound) {\n        parent.removeChild(bottomRebound);\n      }\n    }\n    // These are here to to make sure that we completely delete all traces of the removed DOM objects.\n    delete focusTrapElement.topReboundElement;\n    delete focusTrapElement.bottomReboundElement;\n  }\n}\n\n// this helper exists to enable the focus trap class to handle vanilla html elements\n// it's primary concern is to keep TS happy.\n// end users should prefer using the CdsBaseFocusTrap component to this method.\n// but it exists...\nexport function castHtmlElementToFocusTrapElement(el: HTMLElement): FocusTrapElement {\n  return el as FocusTrapElement;\n}\n\nexport class FocusTrap {\n  focusTrapElement: FocusTrapElement;\n  private previousFocus: HTMLElement;\n  private onFocusInEvent: any;\n\n  firstFocusElement: HTMLElement | FocusTrapElement;\n\n  active = false;\n\n  constructor(hostElement: FocusTrapElement) {\n    hostElement = castHtmlElementToFocusTrapElement(hostElement);\n\n    if (!hostElement.focusTrapId) {\n      hostElement.focusTrapId = createId();\n    }\n\n    // @deprecation\n    // reflect attr for non-Lit Element traps\n    // IMPORTANT! Using something other than a LitElement will break in React.\n    // The preference should be to use the CdsBaseFocusTrap component\n    // If that is not possible, avoid passing HTMLElement through here\n    if (!(hostElement instanceof LitElement) && !hostElement.hasAttribute(CDS_FOCUS_TRAP_ID_ATTR)) {\n      hostElement.setAttribute(CDS_FOCUS_TRAP_ID_ATTR, hostElement.focusTrapId);\n    }\n\n    this.focusTrapElement = hostElement;\n  }\n\n  enableFocusTrap() {\n    const fte = this.focusTrapElement;\n    const firstFocusElement = fte.querySelector('[cds-first-focus]');\n    const contentWrapper = fte.shadowRoot ? fte.shadowRoot.querySelector('.private-host[tabindex]') : null;\n    const activeEl = document.activeElement;\n\n    if (FocusTrapTracker.getCurrent() === fte) {\n      throw new Error('Focus trap is already enabled for this instance.');\n    }\n\n    this.firstFocusElement =\n      (firstFocusElement as HTMLElement) || (contentWrapper as HTMLElement) || this.focusTrapElement;\n\n    addReboundElementsToFocusTrapElement(fte);\n\n    if (!isFocusable(fte)) {\n      fte.setAttribute('tabindex', '-1');\n    }\n\n    if (activeEl && isHTMLElement(activeEl)) {\n      this.previousFocus = activeEl as HTMLElement;\n    }\n\n    FocusTrapTracker.setCurrent(fte.focusTrapId);\n\n    // setTimeout here is required for Safari which may try to set focus on\n    // element before it is visible...\n    const focusTimer = setTimeout(() => {\n      this.firstFocusElement.focus();\n      clearTimeout(focusTimer);\n    }, 10);\n\n    this.onFocusInEvent = this.onFocusIn.bind(this);\n    document.addEventListener('focusin', this.onFocusInEvent);\n    this.active = true;\n  }\n\n  removeFocusTrap() {\n    document.removeEventListener('focusin', this.onFocusInEvent);\n    removeReboundElementsFromFocusTrapElement(this.focusTrapElement);\n    FocusTrapTracker.activatePreviousCurrent();\n    this.active = false;\n    if (this.previousFocus) {\n      this.previousFocus.focus();\n    }\n  }\n\n  private onFocusIn(event: FocusEvent) {\n    refocusIfOutsideFocusTrapElement(\n      event.composedPath()[0] as HTMLElement,\n      this.focusTrapElement,\n      this.firstFocusElement\n    );\n  }\n}\n"]}